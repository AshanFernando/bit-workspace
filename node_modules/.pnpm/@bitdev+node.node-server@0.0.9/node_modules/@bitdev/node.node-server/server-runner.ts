import { last } from 'lodash';
import { requireUncached } from "./require-uncached.js";

export type StopFn = () => Promise<void>;

let stopFn: StopFn|undefined;

export async function run() {
  const mainFile = last(process.argv);
  const runModule = await requireUncached(mainFile);
  if (stopFn) await stopFn();

  const defaultModule = runModule;
  const runFn = defaultModule?.default || defaultModule?.run;
  if (!runFn) throw new Error('run function was not implemented');

  const server = await runFn();
  stopFn = server?.stop;
}

process.on('message', async () => {
  await run();
});

run();
