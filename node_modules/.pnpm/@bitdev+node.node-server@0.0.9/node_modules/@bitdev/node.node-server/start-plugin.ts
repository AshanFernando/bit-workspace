import { Plugin } from "esbuild";
import { ChildProcess, fork } from 'node:child_process';

export type StopFn = () => Promise<void>;


export function startPlugin(mainFile: string): Plugin {
  const serverRunnerPath = require.resolve('./server-runner.js');
  let serverProcess: ChildProcess|undefined;

  function forkProcess() {
    require.resolve('./server-runner.js');
    return fork(serverRunnerPath, [mainFile], {
      execArgv: ['--enable-source-maps']
    });
  }
  
  return {
    name: "start-plugin",
    setup(build) {
      process.on('exit', () => {
        if (!serverProcess) return;
        serverProcess.kill('SIGKILL');
      });

      build.onEnd(async () => {
        if (!serverProcess?.channel) {
          serverProcess = forkProcess();
          return undefined;
        }
        serverProcess.send('');

        return undefined;
      });
    },
  }; 
}
