import { readFileSync } from "node:fs";
import { resolve } from "node:path";
import { AssetManifest } from "./get-manifest.js";

export type GenerateTemplateOptions = {
  publicDir: string;
  publicPath: string;
  indexHtmlPath: string;
}

export async function generateHtmlTemplate(options: GenerateTemplateOptions) {
  const assetManifest = await AssetManifest.fromPath(options.publicDir);
  const tags = assetManifest.getTags(options.publicPath);
  const template = readFileSync(resolve(options.indexHtmlPath), "utf-8");
  // Add the scripts to the <!--scripts--> placeholder and css to the <!--styles--> placeholder
  // This way we can inject the scripts in the body (for deferred loading) and the css in the head
  // Injection the scripts in the body (and with defer) fixes some issues related to React loading before the dom is parsed
  const html = template.replace('<!--scripts-->', tags.scripts).replace('<!--styles-->', tags.stylesheets);

  return html;
}
